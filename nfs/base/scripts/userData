#cloud-config
users:
  - name: cloud-user
    lock_passwd: true
    groups: wheel
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDcYGv4QhrNhDB9ahXEp2x6kn9YZ2RV5GEXcRRYvk4yLpFidvSFJxkE3AonLuOgi7WBVwMofCCWbHDEgBIWNv6RzR41gKQYI+ZgcT5bSZ9ZFhkkgBvTE66q0XyFXYeON+QV1Woxb7FDDmkvpMi9Sp32EMLOaSQwgnWCsI00zmUgM4UYy66UatWqSRaPtLe8ES2IqA/WUcRfxexcFjtS6jsn2R3Xyz+w9IpexWMhTjWmKpH97Ps8Sj61pCgGgMkkvuBDWBhnVy58Hf0tNg2YZnILCUdh0vVZ1LWPpsno2HB+gBzNhJZznSC5x+emUKtpQwOzrdFn51h1ZCEQDAmyZ+Vb acm@bunny
  - name: dale
    lock_passwd: true
    homedir: /export/home/dale
  - name: jill
    lock_passwd: true
    homedir: /export/home/jill
  - name: remy
    lock_passwd: true
    homedir: /export/home/remy

rh_subscription:
  org: 00000000
  activation-key: EXAMPLE
  enable-repo:
    - 'rhel-9-for-x86_64-baseos-rpms'
    - 'rhel-9-for-x86_64-appstream-rpms'

packages:
  - autofs
  - authselect-compat
  - nfs-utils
  - openldap-clients
  - sssd
  - sssd-ldap

write_files:
  - path: /etc/exports.d/home.exports
    content: |
      /export/home *(rw,sync,no_subtree_check,no_root_squash)
      #/exports/home *(rw,sync,no_subtree_check,all_squash,anonuid=65534,anongid=65534)

mounts:
  - [ /dev/disk/by-id/virtio-sssd-conf, /opt, iso9660, 'defaults' ]

runcmd:
# Start nfs daemons
# /usr/sbin/rpcbind -w
# /usr/sbin/rpc.mountd -V 3
# /usr/sbin/rpc.nfsd -G 10 -V 3
# /usr/sbin/rpc.statd --no-notify
# Add the exports directory to the list of exported dirs
# echo "/exports *(rw,fsid=0,async,root_squash)" > /etc/exports.d/city.exports
# exportfs -r

# Show current nfs exports
  - [showmount, -e]
  - [mkdir, -p, /exports/home]
  - [chmod, 777, /exports/home]

  - [cp, /opt/sssd.conf, /etc/sssd/sssd.conf]
  - [systemctl, daemon-reload]
  - [systemctl, enable, sssd.service]
  - [systemctl, start, sssd.service]
  - [systemctl, enable, autofs.service]
  - [systemctl, start, autofs.service]
  # check automounts
  - [automount -m]